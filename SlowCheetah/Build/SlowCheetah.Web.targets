<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.Web.targets
Logic for Web Project transformations
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- If the project is not web, it is an app-type project -->
    <WapProjectTypeGuid>349c5851-65df-11da-9384-00065b846f21</WapProjectTypeGuid>
    <ScIsWap>false</ScIsWap>
    <ScIsWap Condition="'$(WapProjectTypeGuid)' != '' and '$(ProjectTypeGuids)' != ''">$(ProjectTypeGuids.Contains($(WapProjectTypeGuid)))</ScIsWap>
  </PropertyGroup>

  <!--<ItemDefinitionGroup>
    <_FilesToTransform>
      <PublishTransformFile></PublishTransformFile>
    </_FilesToTransform>
  </ItemDefinitionGroup>-->

  <PropertyGroup Condition="'$(ScIsWap)' == 'true'">

    <OnAfterPipelinePreDeployCopyAllFilesToOneFolder>
      $(OnAfterPipelinePreDeployCopyAllFilesToOneFolder);
      ScApplyTransforms;
    </OnAfterPipelinePreDeployCopyAllFilesToOneFolder>

    <CopyAllFilesToSingleFolderForMsdeploy>
      $(CopyAllFilesToSingleFolderForMsdeploy);
      ScApplyTransforms;
    </CopyAllFilesToSingleFolderForMsdeploy>

    <!-- For VS2012 -->
    <PipelineCopyAllFilesToOneFolderForMsdeployDependsOn>
      $(PipelineCopyAllFilesToOneFolderForMsdeployDependsOn);
      ScApplyTransforms;
    </PipelineCopyAllFilesToOneFolderForMsdeployDependsOn>

    <!-- Required for File System -->
    <PipelinePreDeployCopyAllFilesToOneFolderDependsOn>
      $(PipelinePreDeployCopyAllFilesToOneFolderDependsOn);
      ScApplyTransforms;
    </PipelinePreDeployCopyAllFilesToOneFolderDependsOn>

    <!-- required for FS support from the VS publish dialog -->
    <OnAfterCopyAllFilesToSingleFolderForPackage>
      $(OnAfterCopyAllFilesToSingleFolderForPackage);
      ScApplyTransforms;
    </OnAfterCopyAllFilesToSingleFolderForPackage>
  </PropertyGroup>

  <Target Name="ScCollectWapFiles" DependsOnTargets="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms" Condition="'$(ScIsWap)' == 'true'">

    <Message Text="SlowCheetah: Collecting Web files: $(ScIsWap)" Importance="high"/>

    <ItemGroup>
      
      <!-- Do not transform the web.config file -->
      <_FilesToTransform Remove="@(_FilesToTransform)" Condition="'%(Filename)%(Extension)' == 'web.config'"/>
      
      <!-- The output for the transformation should be the temporary package directory -->
      <_FilesToTransform>
        <DestinationFile>$(_PackageTempDir)\%(RelativeDir)%(Filename)%(Extension)</DestinationFile>
        <DestinationFile Condition="'%(Link)' != ''">$(_PackageTempDir)\%(Link)</DestinationFile>
      </_FilesToTransform>
    </ItemGroup>
    
  </Target>

  <Target Name="ScTransformWapPublishProfile" DependsOnTargets="ScApplyTransforms" Condition="'$(ScIsWap)' == 'true'">

    <Message Text="SlowCheetah: Applying Publish transforms" Importance="high"/>

    <!-- Get the name of the publish profile if it is not already set -->
    <ItemGroup>
      <_ScWapPubProfileFullPath Include="$(WebPublishProfileFile)"/>
    </ItemGroup>
    
    <PropertyGroup>
      <_WapPubProfile Condition="'$(_WapPubProfile)' == '' and '@(_ScWapPubProfileFullPath)' != ''">%(_ScWapPubProfileFullPath.Filename)</_WapPubProfile>
    </PropertyGroup>

    <!-- Set the publish transformation file -->
    <ItemGroup>
      <_FilesToTransform>
        <PublishTransformFile>%(RelativeDir)%(Filename).$(_WapPubProfile)%(Extension)</PublishTransformFile>
      </_FilesToTransform>
    </ItemGroup>

    <!-- Transform the previously transformed file according to the publish profile -->
    <SlowCheetah.TransformXml Source="@(_FilesToTransform->'%(DestinationFile)')"
                              Transform="%(PublishTransformFile)"
                              Destinaton="%(DestinationFile)"
                              Condition="Exists('%(PublishTransformFile)') and '$(_WapPubProfile)'!='' and '$(_WapPubProfile)'!='$(Configuration)'"/>

  </Target>

</Project>

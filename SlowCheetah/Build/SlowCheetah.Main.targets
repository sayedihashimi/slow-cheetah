<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.Main.targets
Main logic for defining transformations on build
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <SlowCheetahTaskPath>$(MSBuildThisFileDirectory)..\tools\</SlowCheetahTaskPath>
  </PropertyGroup>

  <!--Main transformation task-->
  <UsingTask TaskName="TransformXml" AssemblyFile="$(SlowCheetahTaskPath)SlowCheetah.dll"/>

  <ItemDefinitionGroup>
    <!-- Default TransformOnBuild values for file types -->
    <None>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </None>
    <Content>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </Content>
    <Resource>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </Resource>
    <EmbeddedResource>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </EmbeddedResource>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <!-- References .dll.config files in referenced projects -->
    <ScAllowCopyReferencedConfig Condition=" '$(ScAllowCopyReferencedConfig)'=='' ">true</ScAllowCopyReferencedConfig>
    <AllowedReferenceRelatedFileExtensions Condition=" '$(ScAllowCopyReferencedConfig)'=='true' ">
      $(AllowedReferenceRelatedFileExtensions);
      .dll.config
    </AllowedReferenceRelatedFileExtensions>
  </PropertyGroup>

  <Target Name="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms">

    <Message Text="SlowCheetah: Collecting Transform files" Importance="high"/>
      
    <ItemGroup>
      <_FilesToTransform Include="@(None);@(Content);@(Resource);@(EmbeddedResource)"
                         Condition=" '%(TransformOnBuild)' == 'true' ">
        <SourceFile>%(FullPath)</SourceFile>
        <TransformFile>%(RelativeDir)%(Filename).$(Configuration)%(Extension)</TransformFile>
        <DestinationFile>$(OutDir)%(RelativeDir)%(Filename)%(Extension)</DestinationFile>
        <DestinationFile Condition="'%(Link)' != ''">$(OutDir)%(Link)</DestinationFile>
      </_FilesToTransform>

    </ItemGroup>

  </Target>

  <Target Name="ScApplyTransforms">
    
    <Message Text="SlowCheetah: Applying Transforms" Importance="high"/>
    <ItemGroup>
      <_DirsToCreate Include="@(_FilesToTransform -> '%(DestinationFile)')"/>  
    </ItemGroup>
    
    <MakeDir Directories="@(_DirsToCreate->'%(RelativeDir)')" Condition=" !Exists('%(RelativeDir)') " />

    <SlowCheetah.TransformXml Source="@(_FilesToTransform->'%(SourceFile)')"
                Transform="%(TransformFile)"
                Destination="%(DestinationFile)"
                Condition=" Exists('%(TransformFile)')"/>
  </Target>
  
  <!-- Import native SlowCheetah behaviour -->
  <Import Project="$(MSBuildThisFileDirectory)SlowCheetah.App.targets"/>

</Project>

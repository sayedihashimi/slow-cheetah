<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.Main.targets
Main logic for defining transformations on build
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <SlowCheetahTaskPath>$(MSBuildThisFileDirectory)..\tools\</SlowCheetahTaskPath>
  </PropertyGroup>
  
  <!-- Goes to SlowCheetah.Transform.targets or possibly SlowCheetah.Transform.XML.targets
  <!-Main transformation task->
  <UsingTask TaskName="TransformXml" AssemblyFile="$(SlowCheetahTaskPath)SlowCheetah.dll"/>
  -->

  <ItemDefinitionGroup>
    <!-- Default TransformOnBuild values for file types -->
    <None>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </None>
    <Content>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </Content>
    <Resource>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </Resource>
    <EmbeddedResource>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
    </EmbeddedResource>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <!--Verifies the project type-->
    <WapProjectTypeGuid>349c5851-65df-11da-9384-00065b846f21</WapProjectTypeGuid>
    <_IsWap Condition=" '$(WapProjectTypeGuid)' != '' and '$(ProjectTypeGuids)' != '' ">$(ProjectTypeGuids.Contains($(WapProjectTypeGuid)))</_IsWap>
    <_IsWap Condition=" '$(_IsWap)' == '' ">false</_IsWap>
    <IsWap Condition=" '$(IsWap)' == ''">$(_IsWap)</IsWap>
    
    <ScProjectType>App</ScProjectType>
    <ScProjectType Condition=" '$(_IsWap)' == 'true' ">Web</ScProjectType>
    
    <!-- References .dll.config files in referenced projects -->
    <ScAllowCopyReferencedConfig Condition=" '$(ScAllowCopyReferencedConfig)'=='' ">true</ScAllowCopyReferencedConfig>
    <AllowedReferenceRelatedFileExtensions Condition=" '$(ScAllowCopyReferencedConfig)'=='true' ">
      $(AllowedReferenceRelatedFileExtensions);
      .dll.config
    </AllowedReferenceRelatedFileExtensions>

    </PropertyGroup>
  
  <!-- 
    Discover all the files that should be transformed
    Separate them into app.config and not app.config
  -->
  <Target Name="DiscoverFilesToTransform">

    <!--
    This will look through items list: None & Content for those
    with Metadata <TransformOnBuild>True</TransformOnBuild>.
    -->
    <ItemGroup>
      <_FilesToTransform Include="@(None);@(Content);@(Resource);@(EmbeddedResource)"
                         Condition=" '%(TransformOnBuild)' == 'true' ">
        <Link>%(Link)</Link>
        <!-- Required to remove the item if necessary later -->
        <OriginalItemSpec>%(Identity)</OriginalItemSpec>
      </_FilesToTransform>
    </ItemGroup>

    <PropertyGroup>
      <_AppConfigFullPath>@(AppConfigWithTargetPath->'%(RootDir)%(Directory)%(Filename)%(Extension)')</_AppConfigFullPath>
    </PropertyGroup>

    <!-- Now look to see if any of these are the app.config file -->
    <ItemGroup>
      <_FilesToTransform Condition=" '%(Filename)%(Extension)'=='app.config' ">
        <IsAppConfig>true</IsAppConfig>
        <!-- Required to remove the item if necessary later -->
        <OriginalItemSpec>%(Identity)</OriginalItemSpec>
      </_FilesToTransform>
    </ItemGroup>

    <ItemGroup>
      <_FilesToTransformNotAppConfig Include="@(_FilesToTransform)"
                                     Condition=" '%(IsAppConfig)'!='true'">
        <!-- Required to remove the item if necessary later -->
        <OriginalItemSpec>%(Identity)</OriginalItemSpec>
        <Link>%(_FilesToTransform.Link)</Link>
      </_FilesToTransformNotAppConfig>

      <_AppConfigToTransform  Include="@(_FilesToTransform)"
                              Condition=" '%(IsAppConfig)'=='true'"/>
    </ItemGroup>
  </Target>

  <Import Project="SlowCheetah.$(ScProjectType).targets" Condition=" '$(ScProjectType)' != '' "/>
  

  <!-- 
  ***********************************************************
                ClickOnce related items below
  ***********************************************************
  -->

  <!-- Target was named: SlowCheetah_ClickOnceUpdate -->
  <Target Name="ScReplaceAppConfigItem"
          BeforeTargets="_DeploymentComputeClickOnceManifestInfo;BuiltProjectOutputGroup"
          DependsOnTargets="TransformAllFiles">
  </Target>

  <Target Name="SlowCheetah_ClickOnceLooseFileUpdate" AfterTargets="_DeploymentComputeClickOnceManifestInfo" DependsOnTargets="DiscoverFilesToTransform">
    <!-- For non app.config files which are being transformed we need to remove the original item and replace it with the transformed one -->
    <ItemGroup>
      <_DeploymentManifestFiles Remove="%(_FilesToTransformNotAppConfig.OriginalItemSpec)" />
      <!-- Implementation for non-Link files -->
      <_DeploymentManifestFiles Include="@(_FilesToTransformNotAppConfig->'$(OutDir)%(RelativeDir)%(Filename)%(Extension)')"
                                Condition=" '%(_FilesToTransformNotAppConfig.Link)'=='' ">
        <TargetPath Condition=" '%(_FilesToTransformNotAppConfig.Link)'=='' ">%(RelativeDir)%(Filename)%(Extension)</TargetPath>
      </_DeploymentManifestFiles>

      <!-- Implementation for Linked files -->
      <_DeploymentManifestFiles Include="@(_FilesToTransformNotAppConfig->'$(OutDir)%(Link)')"
                                Condition=" '%(_FilesToTransformNotAppConfig.Link)'!='' ">
        <TargetPath>%(_FilesToTransformNotAppConfig.Link)</TargetPath>
      </_DeploymentManifestFiles>
    </ItemGroup>
  </Target>

  <!-- 
  ***********************************************************
              Setup project related items below
  ***********************************************************
  -->

  <PropertyGroup>
    <SlowCheetahEnableSetupProjects Condition=" '$(SlowCheetahEnableSetupProjects)'=='' ">true</SlowCheetahEnableSetupProjects>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(SlowCheetahEnableSetupProjects)'=='true'">
    
    <AddAppConfigToBuildOutputs>false</AddAppConfigToBuildOutputs>

    <BuiltProjectOutputGroupDependsOn>
      $(BuiltProjectOutputGroupDependsOn);
      AfterBuiltProjectOutputGroup
    </BuiltProjectOutputGroupDependsOn>
  </PropertyGroup>

  <Target Name="AfterBuiltProjectOutputGroup" DependsOnTargets="TransformAllFiles">
    
    <ItemGroup>
      <_TmpAppConfig Include="@(AppConfigWithTargetPath->'$(OutDir)%(TargetPath)')" />
    </ItemGroup>

    <!-- 
      We need to get the full path to the files included in the Identiy metadata.
      This is required for Worker Roles. The target CopyWorkerRoleFiles attempts to copy but
      does not use the FullPath so it will not locate the files otherwise.
      See https://github.com/sayedihashimi/slow-cheetah/issues/44.
    -->
    <ItemGroup>
      <_FilesToTransformNotAppConfig>
        <FullPathToItem Condition=" '%(Link)'=='' ">$([System.IO.Path]::GetFullPath( $(OutDir)%(RelativeDir)%(Filename)%(Extension) ))</FullPathToItem>
        <FullPathToItem Condition=" '%(Link)'!='' ">$([System.IO.Path]::GetFullPath( $(OutDir)%(Link) ))</FullPathToItem>
      </_FilesToTransformNotAppConfig>
    </ItemGroup>

    <ItemGroup>
      
      <BuiltProjectOutputGroupOutput Include="@(_TmpAppConfig->'%(FullPath)')">
        <!-- For compatibility with 2.0 -->
        <OriginalItemSpec>$(AppConfig)</OriginalItemSpec>
      </BuiltProjectOutputGroupOutput>

      <BuiltProjectOutputGroupOutput Include="@(_FilesToTransformNotAppConfig->'%(FullPathToItem)')"
                                     Condition=" '%(_FilesToTransformNotAppConfig.Link)'==''">
        <OriginalItemSpec>@(_FilesToTransformNotAppConfig->'$(OutDir)%(RelativeDir)%(Filename)%(Extension)')</OriginalItemSpec>
        <TargetPath>@(_FilesToTransformNotAppConfig->'%(RelativeDir)%(Filename)%(Extension)')</TargetPath>
      </BuiltProjectOutputGroupOutput>

      <BuiltProjectOutputGroupOutput Include="@(_FilesToTransformNotAppConfig->'%(FullPathToItem)')"
                                     Condition=" '%(_FilesToTransformNotAppConfig.Link)'!=''">
        <OriginalItemSpec>@(_FilesToTransformNotAppConfig->'$(OutDir)%(Link)')</OriginalItemSpec>
        <TargetPath>@(_FilesToTransformNotAppConfig->'%(Link)')</TargetPath>
      </BuiltProjectOutputGroupOutput>
      
    </ItemGroup>
    
  </Target>
  
</Project>

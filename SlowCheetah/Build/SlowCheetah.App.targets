<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.App.targets
Logic for App Project transformations
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- If the project is not web, it is an app-type project -->
    <WapProjectTypeGuid>349c5851-65df-11da-9384-00065b846f21</WapProjectTypeGuid>
    <ScIsApp Condition="'$(ScIsApp)' == '' and '$(ScIsWap)' == true">false</ScIsApp>
    <ScIsApp Condition="'$(ScIsApp)' == ''">true</ScIsApp>

    <!-- The path for the intermediate app.config file generated by SlowCheetah -->
    <ScIntermediateAppConfig>$(IntermediateOutputPath)$(MSBuildProjectFile)-sc.App.config</ScIntermediateAppConfig>

    <ScAppConfigName Condition="'$(ScAppConfigName)' == ''">app.config</ScAppConfigName>
    
  </PropertyGroup>

  <Target Name="ScCollectAppFiles" DependsOnTargets="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms">

    <Message Text="SlowCheetah: Collecting App files" Importance="low"/>
    
    <PropertyGroup>
      <_AppConfigFullPath>@(AppConfigWithTargetPath->'%(RootDir)%(Directory)%(Filename)%(Extension)')</_AppConfigFullPath>
    </PropertyGroup>

    <ItemGroup>
      <!-- Remove app.config transforms and execute them separately -->
      <ScAppConfigToTransform Include="@(ScFilesToTransform)" Condition="'%(Filename)%(Extension)'=='$(ScAppConfigName)'"/>
      <ScFilesToTransform Remove="@(ScFilesToTransform)" Condition="'%(Filename)%(Extension)'=='$(ScAppConfigName)'"/>
    </ItemGroup>

    <PropertyGroup>
      <!-- Determine if an app.config file has a transform -->
      <ScHasAppConfigTransform>false</ScHasAppConfigTransform>
      <!-- If there is a transform for the current build configuration -->
      <ScHasAppConfigConfigurationTransform Condition="Exists('@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')')">true</ScHasAppConfigConfigurationTransform>
      <!-- There is a transform for the current publish profile -->
      <ScHasAppConfigPublishProfileTransform Condition=" Exists('@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')') ">true</ScHasAppConfigPublishProfileTransform>
      <!-- If the configuration and the publish profile are the same, only one transformation is needed -->
      <ScHasAppConfigPublishProfileTransform Condition=" '$(Configuration)'=='$(PublishProfile)' ">false</ScHasAppConfigPublishProfileTransform>
      <!-- If the file has either of the transformations -->
      <ScHasAppConfigTransform Condition=" '$(ScHasAppConfigConfigurationTransform)'=='true' ">true</ScHasAppConfigTransform>
      <ScHasAppConfigTransform Condition=" '$(ScHasAppConfigPublishProfileTransform)'=='true' ">true</ScHasAppConfigTransform>
    
  </PropertyGroup>

    <!-- The file may be transformed multiple times, so copy it to intermediate path and transform from there -->
    <Copy SourceFiles="$(AppConfig)" DestinationFiles="$(ScIntermediateAppConfig)"/>
        
  </Target>

  <Target Name="ScTransformAppConfig" DependsOnTargets="ScCollectAppFiles" BeforeTargets="_CopyAppConfigFile">

    <Message Text="Applying app transformations: $(ScHasAppConfigTransform)" Importance="low"/>

    <!-- Specific transformations for the app.config file -->
    <SlowCheetah.TransformXml Source="$(ScIntermediateAppConfig)"
                  Transform="@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')"
                  Destination="$(ScIntermediateAppConfig)"
                  Condition="'$(ScHasAppConfigConfigurationTransform)' == 'true'"/>
  <SlowCheetah.TransformXml Source="$(ScIntermediateAppConfig)"
                  Transform="@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')"
                  Destination="$(ScIntermediateAppConfig)"
                  Condition="'$(ScHasAppConfigPublishProfileTransform)'=='true'"/>

    <!-- Rewrite App.config build variables so the copy target gets it from new location -->
    <PropertyGroup Condition="'$(ScHasAppConfigTransform)' == 'true'">
      <AppConfig>$(ScIntermediateAppConfig)</AppConfig>
    </PropertyGroup>
    
    <ItemGroup Condition="'$(ScHasAppConfigTransform)' == 'true'">
      <AppConfigWithTargetPath Remove="@(AppConfigWithTargetPath)" />
      <AppConfigWithTargetPath Include="$(AppConfig)">
        <TargetPath>$(TargetFileName).config</TargetPath>
      </AppConfigWithTargetPath>
    </ItemGroup>
    
  </Target>
  
</Project>

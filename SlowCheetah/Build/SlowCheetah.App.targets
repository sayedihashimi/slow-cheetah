<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.App.targets
Logic for App Project transformations
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemDefinitionGroup>
    <!--Initializing list of files to be transformed-->
    <_FilesToTransform>
      <IsAppConfig>false</IsAppConfig>
    </_FilesToTransform>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <!-- If the project is not a Web Application, execute these two tasks before build -->
    <BuildDependsOn>
      $(BuildDependsOn);
      TransformAllFiles;
      ScReplaceAppConfigItem;
    </BuildDependsOn>
    <!-- Before transforming the files, discover which should be transformed -->
    <TransformAllFilesDependsOn>
      DiscoverFilesToTransform;
    </TransformAllFilesDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <__SC_IntermediateAppConfig>$(IntermediateOutputPath)$(MSBuildProjectFile)-sc.App.config</__SC_IntermediateAppConfig>
  </PropertyGroup>

  <!--Main task for transforming all the files (if not associated with a Web Application)-->
  <Target Name="TransformAllFiles"
          DependsOnTargets="$(TransformAllFilesDependsOn)" BeforeTargets="_CopyAppConfigFile">

    <!--  -->
    <ItemGroup>
      <_AppConfigTarget Include="@(AppConfigWithTargetPath->'$(OutDir)%(TargetPath)')" />
    </ItemGroup>

    <!--  -->
    <PropertyGroup>
      <_AppConfigDest>@(_AppConfigTarget->'%(FullPath)')</_AppConfigDest>
    </PropertyGroup>

    <!--  -->
    <ItemGroup>
      <_TmpLinkFiles Remove="@(_TmpLinkFiles)" />
      <_TmpLinkFiles Include="@(_FilesToTransformNotAppConfig->'%(Link)')" />
    </ItemGroup>

    <!-- This will handle non Link files -->
    <MakeDir Directories="@(_FilesToTransformNotAppConfig->'$(OutDir)%(RelativeDir)')"
             Condition="Exists('%(RelativeDir)%(Filename).$(Configuration)%(Extension)')
             and '%(Link)'=='' " />

    <!-- This will handle Link files -->
    <MakeDir Directories="@(_TmpLinkFiles->'$(OutDir)%(RelativeDir)')"
                 Condition=" '%(Link)'!='' " />

    <!-- Determines wether the project requires an app.config transformation -->
    <PropertyGroup>
      <_Sc_HasAppConfigTransform>false</_Sc_HasAppConfigTransform>
      <_Sc_HasAppConfigConfigurationTransform Condition=" Exists( '@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')' ) ">true</_Sc_HasAppConfigConfigurationTransform>
      <_Sc_HasAppConfigPublishProfileTransform Condition=" Exists( '@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')' ) ">true</_Sc_HasAppConfigPublishProfileTransform>
      <_Sc_HasAppConfigPublishProfileTransform Condition=" '$(Configuration)'=='$(PublishProfile)' ">false</_Sc_HasAppConfigPublishProfileTransform>
      <_Sc_HasAppConfigTransform Condition=" '$(_Sc_HasAppConfigConfigurationTransform)'=='true' ">true</_Sc_HasAppConfigTransform>
      <_Sc_HasAppConfigTransform Condition=" '$(_Sc_HasAppConfigPublishProfileTransform)'=='true' ">true</_Sc_HasAppConfigTransform>
    </PropertyGroup>

    <Message Text="Tasks path: $(SlowCheetahTaskPath)" Importance="low"/>

    <!-- we may transform the file multiple times so copy it to dest and then use that as source for all transforms -->
    <Copy SourceFiles="$(AppConfig)" DestinationFiles="$(__SC_IntermediateAppConfig)"/>

    <SlowCheetah.TransformXml Source="$(__SC_IntermediateAppConfig)"
                  Transform="@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')"
                  Destination="$(__SC_IntermediateAppConfig)"
                  Condition=" '$(_Sc_HasAppConfigConfigurationTransform)'=='true' " />

    <SlowCheetah.TransformXml Source="$(__SC_IntermediateAppConfig)"
                  Transform="@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')"
                  Destination="$(__SC_IntermediateAppConfig)"
                  Condition=" '$(_Sc_HasAppConfigPublishProfileTransform)'=='true' " />

    <PropertyGroup Condition=" '$(_Sc_HasAppConfigTransform)'=='true' " >
      <AppConfig>$(__SC_IntermediateAppConfig)</AppConfig>
    </PropertyGroup>

    <ItemGroup Condition=" '$(_Sc_HasAppConfigTransform)'=='true' " >
      <AppConfigWithTargetPath Remove="@(AppConfigWithTargetPath)" />
      <AppConfigWithTargetPath Include="$(AppConfig)">
        <TargetPath>$(TargetFileName).config</TargetPath>
      </AppConfigWithTargetPath>
    </ItemGroup>

    <!-- Transform the non-Link files -->
    <SlowCheetah.TransformXml Source="@(_FilesToTransformNotAppConfig->'%(FullPath)')"
                  Transform="%(RelativeDir)%(Filename).$(Configuration)%(Extension)"
                  Destination="@(_FilesToTransformNotAppConfig->'$(OutDir)%(RelativeDir)%(Filename)%(Extension)')"
                  Condition=" Exists('%(RelativeDir)%(Filename).$(Configuration)%(Extension)')
                              and '%(Link)'=='' " />

    <!-- Transform the Link files into correct location -->
    <SlowCheetah.TransformXml Source="@(_FilesToTransformNotAppConfig->'%(FullPath)')"
                  Transform="%(RelativeDir)%(Filename).$(Configuration)%(Extension)"
                  Destination="@(_FilesToTransformNotAppConfig->'$(OutDir)%(Link)')"
                  Condition="Exists('%(RelativeDir)%(Filename).$(Configuration)%(Extension)')
                              and '%(Link)'!='' " />

  </Target>
  
</Project>

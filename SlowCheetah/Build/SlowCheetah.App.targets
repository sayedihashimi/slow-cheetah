<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.App.targets
Logic for App Project transformations
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- If the project is not web, it is an app-type project -->
    <WapProjectTypeGuid>349c5851-65df-11da-9384-00065b846f21</WapProjectTypeGuid>
    <ScIsApp>true</ScIsApp>
    <ScIsApp Condition="'$(WapProjectTypeGuid)' != '' and '$(ProjectTypeGuids)' != ''">$(!ProjectTypeGuids.Contains($(WapProjectTypeGuid)))</ScIsApp>
  
    <!-- For these type of apps, apply transforms after the build -->
    <BuildDependsOn Condition="'$(ScIsApp)' == 'true'">
      $(BuildDependsOn);
      ScApplyTransforms;
    </BuildDependsOn>

    <!-- The path for the intermediate app.config file generated by SlowCheetah -->
    <__SC_IntermediateAppConfig>$(IntermediateOutputPath)$(MSBuildProjectFile)-sc.App.config</__SC_IntermediateAppConfig>
    
  </PropertyGroup>

  <Target Name="ScCollectAppFiles" DependsOnTargets="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms">

    <Message Text="SlowCheetah: Collecting App files" Importance="high"/>
    
    <PropertyGroup>
      <_AppConfigFullPath>@(AppConfigWithTargetPath->'%(RootDir)%(Directory)%(Filename)%(Extension)')</_AppConfigFullPath>
    </PropertyGroup>

    <ItemGroup>
      <!-- Remove app.config transforms and execute them separately -->
      <_AppConfigToTransform Include="@(_FilesToTransform)" Condition="'%(Filename)%(Extension)'=='app.config'"/>
      <_FilesToTransform Remove="@(_FilesToTransform)" Condition="'%(Filename)%(Extension)'=='app.config'"/>
    </ItemGroup>

    <ItemGroup>
      <_AppConfigTarget Include="@(AppConfigWithTargetPath->'$(OutDir)%(TargetPath)')" />
    </ItemGroup>

    <PropertyGroup>
      <_AppConfigDest>@(_AppConfigTarget->'%(FullPath)')</_AppConfigDest>
    </PropertyGroup>

    <PropertyGroup>
      <!-- Determine if an app.config file has a transform -->
      <_Sc_HasAppConfigTransform>false</_Sc_HasAppConfigTransform>
      <!-- If there is a transform for the current build configuration -->
      <_Sc_HasAppConfigConfigurationTransform Condition="Exists('@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')')">true</_Sc_HasAppConfigConfigurationTransform>
      <!-- There is a transform for the current publish profile -->
      <_Sc_HasAppConfigPublishProfileTransform Condition=" Exists('@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')') ">true</_Sc_HasAppConfigPublishProfileTransform>
      <!-- If the configuration and the publish profile are the same, only one transformation is needed -->
      <_Sc_HasAppConfigPublishProfileTransform Condition=" '$(Configuration)'=='$(PublishProfile)' ">false</_Sc_HasAppConfigPublishProfileTransform>
      <!-- If the file has either of the transformations -->
      <_Sc_HasAppConfigTransform Condition=" '$(_Sc_HasAppConfigConfigurationTransform)'=='true' ">true</_Sc_HasAppConfigTransform>
      <_Sc_HasAppConfigTransform Condition=" '$(_Sc_HasAppConfigPublishProfileTransform)'=='true' ">true</_Sc_HasAppConfigTransform>
    </PropertyGroup>

    <!-- The file may be transformed multiple times, so copy it to intermediate path and transform from there -->
    <Copy SourceFiles="$(AppConfig)" DestinationFiles="$(__SC_IntermediateAppConfig)"/>
        
  </Target>

  <Target Name="ScTransformAppConfig" DependsOnTargets="ScCollectAppFiles" BeforeTargets="_CopyAppConfigFile">

    <Message Text="Applying app transformations: $(_Sc_HasAppConfigTransform)" Importance="high"/>

    <!-- Specific transformations for the app.config file -->
    <SlowCheetah.TransformXml Source="$(__SC_IntermediateAppConfig)"
                  Transform="@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')"
                  Destination="$(__SC_IntermediateAppConfig)"
                  Condition="'$(_Sc_HasAppConfigConfigurationTransform)' == 'true'"/>
  <SlowCheetah.TransformXml Source="$(__SC_IntermediateAppConfig)"
                  Transform="@(_AppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')"
                  Destination="$(__SC_IntermediateAppConfig)"
                  Condition="'$(_Sc_HasAppConfigPublishProfileTransform)'=='true'"/>

    <!-- Rewrite App.config build variables so the copy target gets it from new location -->
    <PropertyGroup Condition="'$(_Sc_HasAppConfigTransform)' == 'true'">
      <AppConfig>$(__SC_IntermediateAppConfig)</AppConfig>
    </PropertyGroup>
    
    <ItemGroup Condition="'$(_Sc_HasAppConfigTransform)' == 'true'">
      <AppConfigWithTargetPath Remove="@(AppConfigWithTargetPath)" />
      <AppConfigWithTargetPath Include="$(AppConfig)">
        <TargetPath>$(TargetFileName).config</TargetPath>
      </AppConfigWithTargetPath>
    </ItemGroup>
    
  </Target>
  
</Project>
